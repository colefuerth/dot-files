#!/usr/bin/env bash

set -euo pipefail

# Use nix-output-monitor is available else fall back to nix
NIX=$(if [ ! -z $(which nom) ]; then echo "nom"; else echo "nix"; fi)

REMOTE="eu.nixbuild.net"

RESULT_PATH=$(
    $NIX build \
        --print-out-paths \
        --system aarch64-linux \
        --max-jobs 0 \
        --eval-store auto \
        --store ssh-ng://$REMOTE \
        --log-format internal-json -v \
        $* \
)
nix copy --from ssh://$REMOTE --print-build-logs $RESULT_PATH
echo $RESULT_PATH
